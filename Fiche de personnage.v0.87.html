<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche SCCS - Module Codex v0.87</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,700&family=Spectral:wght@600;700;800&display=swap" rel="stylesheet">
    
    <script src="registre.js"></script>

    <style>
        /* === CONFIGURATION GLOBALE === */
        * { box-sizing: border-box; }

        body { 
            margin: 0; 
            padding: 0; 
            background-color: transparent; 
            font-family: 'Cormorant Garamond', serif;
            color: #000000;
            overflow: hidden; /* On laisse le script g√©rer l'affichage */
        }

        /* --- CONTENEUR A4 RIGIDE --- */
        .sheet-container {
            width: 794px;  /* Largeur fixe A4 */
            height: 1123px; /* Hauteur fixe A4 */
            padding: 40px 50px; /* Marges fixes en pixels */
            background-color: #c5a880;
            background-image: url("https://www.transparenttextures.com/patterns/clean-gray-paper.png");
            background-blend-mode: multiply;
            position: relative; 
            margin: 0 auto;
            transform-origin: 0 0; /* Point de pivot pour le zoom : Haut Gauche */
        }

        /* Wrapper pour centrer le r√©sultat du zoom */
        .layout-wrapper {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            display: block;
            position: relative;
        }

        /* --- STYLES DE TABLEAUX RIGIDES --- */
        table { border-collapse: collapse; } /* Plus de width 100% par d√©faut */
        td { vertical-align: top; }
        
        /* Classes utilitaires pour figer les largeurs */
        .w-full { width: 100%; }
        .w-half { width: 50%; }
        
        /* Colonnes sp√©cifiques pour l'Attaque et la D√©fense */
        .col-label-sm { width: 80px; } /* Largeur fixe pour "Direct", "T√™te"... */
        .col-val-sm { width: 50px; }   /* Largeur fixe pour la case du chiffre */
        
        /* Colonnes sp√©cifiques pour les Armes */
        .col-weapon { width: 220px; }
        
        /* --- TYPOGRAPHIE --- */
        .font-title { font-family: 'Cinzel', serif; }
        .font-body { font-family: 'Cormorant Garamond', serif; }
        .font-digit { font-family: 'Spectral', serif; }
        ::placeholder { color: #000000 !important; opacity: 0.6; font-style: italic; }
        input, select { color: #000000; outline: none; }

        /* --- BOUTONS --- */
        .header-actions { display: flex; gap: 5px; }
        .btn-action {
            cursor: pointer; opacity: 0.4; transition: opacity 0.2s;
            padding: 0 2px; font-size: 1.1rem;
            color: #000000; background: none; border: none;
        }
        .btn-action:hover { opacity: 1; }

        /* --- CHAMPS DE FORMULAIRE --- */
        .label-cell {
            padding: 4px 0; border-bottom: 1px solid rgba(0, 0, 0, 0.4);
            vertical-align: baseline; font-size: 0.8rem; font-weight: 800;
            text-transform: uppercase; color: #000000; white-space: nowrap; font-family: 'Cinzel', serif;
        }
        .value-cell {
            padding: 0 5px 0 0; border-bottom: 1px solid rgba(0, 0, 0, 0.4);
            vertical-align: baseline; text-align: right;
        }
        .clean-input {
            width: 100%; background: transparent; border: none; 
            text-align: right; font-weight: 700; font-size: 1.6rem; color: #000000;
            font-family: 'Spectral', serif; padding: 0; margin: 0; line-height: 1.2;
        }
        .identity-select, .identity-input {
            appearance: none; background: transparent; border: none;
            border-bottom: 2px solid rgba(0, 0, 0, 0.5); width: 100%;
            padding: 0; height: 30px; vertical-align: bottom; border-radius: 0; color: #000000;
        }
        .identity-select { font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.2rem; }
        .identity-input { font-family: 'Spectral', serif; font-weight: 700; font-size: 1.2rem; }

        .check-box {
            width: 14px; height: 14px; border: 2px solid #000000;
            display: inline-flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.3); margin-right: 8px; cursor: pointer; vertical-align: middle; 
        }
        .check-box.active { background: #000000; }
        .check-box.active::after { content: "‚úì"; color: #fff; font-size: 12px; line-height: 1; }

        .area-textarea {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.3);
            width: 100%; height: 50mm; resize: none; padding: 0 8px;
            font-family: 'Cormorant Garamond', serif; font-weight: 600; font-size: 1.2rem;
            color: #000000; line-height: 30px;
            background-image: linear-gradient(transparent 29px, rgba(0, 0, 0, 0.2) 30px);
            background-size: 100% 30px; background-attachment: local;
            display: block; margin-top: 4px; overflow: hidden;
        }
        .box-cell {
            border: 2px solid rgba(0, 0, 0, 0.3);
            background-color: rgba(255,255,255,0.1);
            border-radius: 4px; padding: 8px;
        }
        .spacer-row { height: 15px; } 
        
        .footer-absolute {
            position: absolute; bottom: 10mm; left: 15mm; right: 15mm;   
            height: 20px; text-align: center;
        }
        .portrait-img-custom {
            width: 100%; height: 100%; object-fit: cover;
            filter: sepia(0.2) contrast(1.1) brightness(0.9); mix-blend-mode: multiply;
        }

        /* --- IMPRESSION --- */
        @media print {
            .header-actions { display: none !important; }
            .sheet-container {
                transform: none !important; margin: 0 !important;
                width: 794px !important; height: 1123px !important;
                page-break-after: always;
                box-shadow: none; border: none;
            }
            .layout-wrapper { display: block !important; height: auto !important; overflow: visible !important; }
            body { overflow: visible !important; }
        }
    </style>
</head>
<body>

    <div class="layout-wrapper" id="zoomWrapper">
        <div class="sheet-container" id="sheetTarget">
            <input type="file" id="file-upload" style="display:none" accept=".json" onchange="handleFileUpload(this)">

            <table style="width: 100%;">
                <tr>
                    <td style="width: 170px; padding-right: 20px;">
                        <div style="width:150px; height:175px; border: 4px solid rgba(0,0,0,0.6); padding:4px;">
                            <div id="portrait-container" style="width:100%; height:100%; border: 2px dashed rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; overflow:hidden;"></div>
                        </div>
                    </td>
                    <td style="vertical-align: bottom;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                            <label class="font-title text-xs font-black uppercase tracking-[0.3em]">Nom du personnage</label>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <input type="text" id="char-name" class="w-full bg-transparent border-b-4 border-black/60 text-4xl font-black py-1 font-title" placeholder="" oninput="updateProfileName(this.value)">
                            <div class="header-actions ml-2">
                                <button onclick="resetSheet()" class="btn-action btn-reset" title="Effacer">‚Ü∫</button>
                                <span>|</span> 
                                <button onclick="exportSingleJSON()" class="btn-action btn-export" title="Sauvegarder">üíæ</button>
                                <button onclick="window.print()" class="btn-action btn-print" title="Imprimer">üñ®Ô∏è</button>
                            </div>
                        </div>

                        <table style="width:100%; margin-top:10px;">
                            <tr>
                                <td style="padding-right: 15px; width: 40%;">
                                    <label class="block text-[9px] font-black uppercase tracking-widest mb-1 font-title">Esp√®ce</label>
                                    <select id="race-select" class="identity-select" onchange="updateRace(); updatePortrait()">
                                        <option value="HUMAIN">HUMAIN</option>
                                        <option value="ELFE">ELFE</option>
                                        <option value="NAIN">NAIN</option>
                                        <option value="ORQUE">ORQUE</option>
                                    </select>
                                </td>
                                <td style="padding-right: 15px; width: 40%;">
                                    <label class="block text-[9px] font-black uppercase tracking-widest mb-1 font-title">Genre</label>
                                    <select id="gender-select" class="identity-select" onchange="updatePortrait()">
                                        <option value="MASCULIN">MASCULIN</option>
                                        <option value="F√âMININ">F√âMININ</option>
                                    </select>
                                </td>
                                <td style="width: 20%;">
                                    <label class="block text-[9px] font-black uppercase tracking-widest mb-1 font-title">PA</label>
                                    <input type="number" id="val-pa" class="identity-input text-left" value="0">
                                </td>
                            </tr>
                        </table>

                        <table style="width:100%; margin-top:10px;">
                            <tr>
                                <td class="text-[10px] font-bold w-24 py-1 align-baseline border-b border-black/30">YEUX:</td>
                                <td class="border-b border-black/30"><input type="text" id="identity-eyes" class="w-full bg-transparent outline-none italic font-bold"></td>
                            </tr>
                            <tr>
                                <td class="text-[10px] font-bold w-24 py-1 align-baseline border-b border-black/30">CHEVEUX:</td>
                                <td class="border-b border-black/30"><input type="text" id="identity-hair" class="w-full bg-transparent outline-none italic font-bold"></td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>

            <div class="spacer-row"></div>

            <table style="width:100%;">
                <tr>
                    <td style="width: 340px; padding-right: 15px;">
                        <h2 class="font-title text-xl font-black uppercase border-l-4 border-black pl-3 mb-2">‚öîÔ∏è Attaque</h2>
                        <div style="border:1px solid rgba(0,0,0,0.3); background-color: rgba(0,0,0,0.05); border-radius:4px; padding:10px;">
                            <table style="width:100%;">
                                <tr>
                                    <td style="padding-right: 10px;">
                                        <p class="text-[9px] font-black uppercase mb-1 border-b border-black/40">Type</p>
                                        <table>
                                            <tr><td class="label-cell col-label-sm">Direct</td><td class="value-cell col-val-sm"><input type="number" class="clean-input" value="0"></td></tr>
                                            <tr><td class="label-cell col-label-sm">Circulaire</td><td class="value-cell col-val-sm"><input type="number" class="clean-input" value="0"></td></tr>
                                            <tr><td class="label-cell col-label-sm">Saisie</td><td class="value-cell col-val-sm"><input type="number" id="stat-att-saisie" class="clean-input" value="0"></td></tr>
                                        </table>
                                    </td>
                                    <td>
                                        <p class="text-[9px] font-black uppercase mb-1 border-b border-black/40">Cible</p>
                                        <table>
                                            <tr><td class="label-cell col-label-sm">T√™te</td><td class="value-cell col-val-sm"><input type="number" class="clean-input" value="0"></td></tr>
                                            <tr><td class="label-cell col-label-sm">Tronc</td><td class="value-cell col-val-sm"><input type="number" id="stat-att-tronc" class="clean-input" value="0"></td></tr>
                                            <tr><td class="label-cell col-label-sm">Membres</td><td class="value-cell col-val-sm"><input type="number" class="clean-input" value="0"></td></tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </td>

                    <td style="width: 340px; padding-left: 15px;">
                        <h2 class="font-title text-xl font-black uppercase border-l-4 border-black pl-3 mb-2">üõ°Ô∏è Protection</h2>
                        <div style="border:1px solid rgba(0,0,0,0.3); background-color: rgba(0,0,0,0.05); border-radius:4px; padding:10px;">
                            <table style="width:100%;">
                                <tr>
                                    <td style="padding-right: 10px;">
                                        <p class="text-[9px] font-black uppercase mb-1 border-b border-black/40">D√©fense</p>
                                        <table>
                                            <tr><td class="label-cell col-label-sm"><span style="font-size:0.7em;">vs</span> Direct</td><td class="value-cell col-val-sm"><input type="number" class="clean-input" value="0"></td></tr>
                                            <tr><td class="label-cell col-label-sm"><span style="font-size:0.7em;">vs</span> Circu.</td><td class="value-cell col-val-sm"><input type="number" class="clean-input" value="0"></td></tr>
                                            <tr><td class="label-cell col-label-sm"><span style="font-size:0.7em;">vs</span> Saisie</td><td class="value-cell col-val-sm"><input type="number" class="clean-input" value="0"></td></tr>
                                        </table>
                                    </td>
                                    <td>
                                        <div class="flex items-end border-b border-black/40 mb-1">
                                            <span class="text-[9px] font-black uppercase flex-grow">R√©sist.</span>
                                            <span class="text-[8px] font-black uppercase w-[30px] text-center">Nat.</span>
                                            <span class="text-[8px] font-black uppercase w-[35px] text-center">Arm.</span>
                                        </div>
                                        <table>
                                            <tr>
                                                <td class="label-cell col-label-sm">T√™te</td>
                                                <td class="value-cell" style="width:30px;"><input type="number" id="res-nat-tete" class="clean-input" value="0"></td>
                                                <td style="width:35px; border-bottom:1px solid rgba(0,0,0,0.4); text-align:center;">
                                                    <span class="font-digit font-bold text-[1.2rem]">+</span><span id="res-arm-tete" class="font-digit font-bold text-[1.4rem]">0</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="label-cell col-label-sm">Tronc</td>
                                                <td class="value-cell" style="width:30px;"><input type="number" id="res-nat-tronc" class="clean-input" value="0"></td>
                                                <td style="width:35px; border-bottom:1px solid rgba(0,0,0,0.4); text-align:center;">
                                                    <span class="font-digit font-bold text-[1.2rem]">+</span><span id="res-arm-tronc" class="font-digit font-bold text-[1.4rem]">0</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="label-cell col-label-sm">Membres</td>
                                                <td class="value-cell" style="width:30px;"><input type="number" id="res-nat-membres" class="clean-input" value="0"></td>
                                                <td style="width:35px; border-bottom:1px solid rgba(0,0,0,0.4); text-align:center;">
                                                    <span class="font-digit font-bold text-[1.2rem]">+</span><span id="res-arm-membres" class="font-digit font-bold text-[1.4rem]">0</span>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </td>
                </tr>
            </table>

            <div class="spacer-row"></div>

            <table style="width:100%;">
                <tr>
                    <td style="width: 450px; padding-right: 20px;">
                        <div class="box-cell">
                            <div class="mb-2 border-b border-black/20 pb-1"><span class="font-title font-black uppercase text-xs">Armes</span></div>
                            
                            <div style="display:flex; gap:10px;">
                                <div class="col-weapon">
                                    <label class="block text-[8px] font-black uppercase">Main Droite</label>
                                    <select id="weapon-select-1" class="w-full bg-transparent font-title font-bold text-sm border-b border-black/40" onchange="updateUI()"></select>
                                </div>
                                <div class="col-weapon">
                                    <label class="block text-[8px] font-black uppercase">Main Gauche</label>
                                    <select id="offhand-select-1" class="w-full bg-transparent font-title font-bold text-sm border-b border-black/40" onchange="updateUI()"></select>
                                </div>
                            </div>
                            <div class="flex justify-between items-center bg-black/5 rounded px-2 py-1 mt-1 mb-3">
                                <div><span id="init-label-1" class="font-title font-bold uppercase text-[8px] mr-2">Initiative</span><span id="init-val-1" class="font-digit font-bold text-sm">0</span></div>
                                <div><span class="font-title font-bold uppercase text-[8px] mr-1">Malus Magie</span><span id="magic-malus-1" class="font-digit font-bold text-sm">0</span></div>
                            </div>

                            <div class="pl-1 my-1"><span class="text-[9px] font-bold italic lowercase">ou</span></div>

                            <div style="display:flex; gap:10px;">
                                <div class="col-weapon">
                                    <label class="block text-[8px] font-black uppercase">Main Droite</label>
                                    <select id="weapon-select-2" class="w-full bg-transparent font-title font-bold text-sm border-b border-black/40" onchange="updateUI()"></select>
                                </div>
                                <div class="col-weapon">
                                    <label class="block text-[8px] font-black uppercase">Main Gauche</label>
                                    <select id="offhand-select-2" class="w-full bg-transparent font-title font-bold text-sm border-b border-black/40" onchange="updateUI()"></select>
                                </div>
                            </div>
                            <div class="flex justify-between items-center bg-black/5 rounded px-2 py-1 mt-1">
                                <div><span id="init-label-2" class="font-title font-bold uppercase text-[8px] mr-2">Initiative</span><span id="init-val-2" class="font-digit font-bold text-sm">0</span></div>
                                <div><span class="font-title font-bold uppercase text-[8px] mr-1">Malus Magie</span><span id="magic-malus-2" class="font-digit font-bold text-sm">0</span></div>
                            </div>
                        </div>

                        <div class="box-cell mt-2">
                            <div class="mb-2 border-b border-black/20 pb-1"><span class="font-title font-black uppercase text-xs">Armure Port√©e</span></div>
                            <label class="block text-[8px] font-black uppercase">Type</label>
                            <select id="armor-select" class="w-full bg-transparent font-title font-bold text-base border-b border-black/40" onchange="updateUI()">
                                <option value="Aucune">Sans Armure</option>
                                <option value="L√©g√®re">Cuir sans Heaume</option>
                                <option value="L√©g√®re_Heaume">Cuir avec Heaume</option>
                                <option value="Moyenne">Mailles sans Heaume</option>
                                <option value="Moyenne_Heaume">Mailles avec Heaume</option>
                                <option value="Lourde">Harnois sans Heaume</option>
                                <option value="Lourde_Heaume">Harnois avec Heaume</option>
                            </select>
                            <div class="flex justify-between items-center bg-black/5 rounded px-2 py-1 mt-2">
                                <div><span class="font-title font-bold uppercase text-[8px] mr-2">Durabilit√©</span><span id="dur-display" class="font-digit font-bold text-sm">0/0</span></div>
                                <div><span class="font-title font-bold uppercase text-[8px] mr-1">Malus Magie</span><span id="magic-malus-armor" class="font-digit font-bold text-sm">0</span></div>
                            </div>
                        </div>
                    </td>

                    <td style="vertical-align: top; padding-left: 20px; border-left: 2px solid rgba(0,0,0,0.2);">
                        <h2 class="font-title text-sm font-black uppercase border-b-2 border-black/40 pb-1 mb-2">Talents</h2>
                        <div id="talents-container"></div>
                    </td>
                </tr>
            </table>

            <div class="spacer-row"></div>

            <h3 class="font-title text-xs font-black uppercase mb-1">Notes</h3>
            <textarea class="area-textarea"></textarea>

            <div class="footer-absolute">
                <div class="text-[9px] text-center text-black uppercase font-black tracking-widest pt-1 border-t border-black/30">
                    Grimoire SCCS VLU Officiel - Fiche Personnage
                </div>
            </div>
        </div>
    </div>

    <script>
        // === SCRIPT ZOOM INTELLIGENT + LOGIQUE ===
        let currentUid = null;

        // Fonction Zoom : appel√©e au chargement et au redimensionnement
        function adjustZoom() {
            if (window.matchMedia('print').matches) return; // Pas de zoom √† l'impression

            const wrapper = document.getElementById('zoomWrapper');
            const sheet = document.getElementById('sheetTarget');
            
            // Dimensions cibles
            const targetW = 794;
            const targetH = 1123;
            
            // Dimensions disponibles (fen√™tre moins marges de s√©curit√©)
            const availW = wrapper.clientWidth;
            const availH = window.innerHeight - 40; // 20px haut/bas

            // Calcul Ratio (On prend le plus petit pour que tout rentre)
            const scale = Math.min(availW / targetW, availH / targetH);
            
            // Application
            sheet.style.transform = `scale(${scale})`;
            
            // Centrage : On d√©cale la fiche au centre de l'espace restant
            const finalW = targetW * scale;
            const leftOffset = (availW - finalW) / 2;
            sheet.style.marginLeft = `${leftOffset}px`;
        }

        window.onload = function() {
            initWeaponSelect();
            const params = new URLSearchParams(window.location.search);
            currentUid = params.get('uid');

            if (currentUid && typeof SCCS_Registre !== 'undefined') {
                loadFromRegistry(currentUid);
                setupAutoSave();
            }

            // Lancer le zoom
            adjustZoom();
            window.addEventListener('resize', adjustZoom);
        };

        // --- RESTE DU CODE (FONCTIONS M√âTIER) ---
        // (Identique √† votre logique pr√©c√©dente, remis ici pour que le copier-coller fonctionne)
        
        const CUSTOM_PORTRAITS_URLS = {
            "HUMAIN_MASCULIN": "portraits/portrait_homme_humain.png",
            "HUMAIN_F√âMININ": "portraits/portrait_femme_humain.png",
            "ELFE_MASCULIN": "portraits/portrait_homme_elfe.png",
            "ELFE_F√âMININ": "portraits/portrait_femme_elfe.png",
            "NAIN_MASCULIN": "portraits/portrait_homme_nain.png",
            "NAIN_F√âMININ": "portraits/portrait_femme_nain.png",
            "ORQUE_MASCULIN": "portraits/portrait_homme_orque.png",
            "ORQUE_F√âMININ": "portraits/portrait_femme_orque.png",
        };

        const state = { talents: { athletisme: false, acrobatie: false, mecanique: false, subtilite: false, perception: false, survie: false, savoir_acad: false } };

        function loadFromRegistry(uid) {
            const profile = SCCS_Registre.getProfile(uid);
            if (!profile) return;
            const data = profile.content || {};
            
            document.querySelectorAll('input, textarea').forEach(el => { el.value = ''; });
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            document.querySelectorAll('input[type=number]').forEach(el => el.value = '0');
            if(document.getElementById('weapon-select-1')) document.getElementById('weapon-select-1').value = "Main Libre";
            if(document.getElementById('weapon-select-2')) document.getElementById('weapon-select-2').value = "Main Libre";

            Object.keys(data).forEach(key => {
                if (key.startsWith('__clean_input_')) {
                    const idx = parseInt(key.replace('__clean_input_', ''));
                    const els = document.querySelectorAll('.clean-input:not([id])');
                    if (els[idx]) els[idx].value = data[key];
                } else if (key.startsWith('__area_')) {
                    const idx = parseInt(key.replace('__area_', ''));
                    const els = document.querySelectorAll('.area-textarea:not([id])');
                    if (els[idx]) els[idx].value = data[key];
                } else {
                    const el = document.getElementById(key);
                    if (el) {
                        if (el.type === 'checkbox') el.checked = data[key];
                        else el.value = data[key];
                    }
                }
            });

            if (data.__state_talents) state.talents = JSON.parse(JSON.stringify(data.__state_talents));
            else updateRace();

            updateOffhandOptions(1); updateOffhandOptions(2); updateUI(); updatePortrait();
        }

        function setupAutoSave() {
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('input', triggerSave);
                el.addEventListener('change', triggerSave);
            });
        }

        function triggerSave() {
            if (!currentUid || typeof SCCS_Registre === 'undefined') return;
            const data = {};
            document.querySelectorAll('input[id], select[id], textarea[id]').forEach(el => {
                if(el.type === 'checkbox') data[el.id] = el.checked;
                else data[el.id] = el.value;
            });
            document.querySelectorAll('.clean-input:not([id])').forEach((el, index) => { data[`__clean_input_${index}`] = el.value; });
            document.querySelectorAll('.area-textarea:not([id])').forEach((el, index) => { data[`__area_${index}`] = el.value; });
            data.__state_talents = state.talents;
            const nameVal = document.getElementById('char-name').value || "Sans Nom";
            SCCS_Registre.updateProfile(currentUid, data, nameVal);
        }

        function updateProfileName(val) { triggerSave(); }
        
        function resetSheet() {
            if (!confirm("Voulez-vous vider les champs de cette fiche ?")) return;
            document.querySelectorAll('input, textarea').forEach(el => { el.value = ''; });
            document.querySelectorAll('select').forEach(el => el.selectedIndex = 0);
            document.querySelectorAll('input[type=number]').forEach(el => el.value = '0');
            state.talents = { athletisme: false, acrobatie: false, mecanique: false, subtilite: false, perception: false, survie: false, savoir_acad: false };
            updateUI(); updatePortrait(); triggerSave();
        }

        function exportSingleJSON() {
            if (!currentUid) return;
            const profile = SCCS_Registre.getProfile(currentUid);
            if (!profile) return;
            const dataStr = JSON.stringify(profile, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `SCCS_Heros_${profile.name.replace(/\s+/g, '_')}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        const WEAPONS_DATA = {
            "Distance": { label: "Armes √† Distance", stats: { init: "1/7", magie: -1 }, items: ["Arc", "Arbal√®te", "Fronde"] },
            "Focalisateur": { label: "Focalisateurs", stats: { init: "6", magie: 0 }, items: ["Grimoire", "Chapelet", "B√¢ton"] },
            "Longue": { label: "Armes Longues (2 mains)", stats: { init: "4", magie: -1 }, items: ["Lance (Longue)", "√âp√©e √† deux mains", "Hache √† deux mains", "Masse √† deux mains"] },
            "Moyenne": { label: "Armes Moyennes (1 main)", stats: { init: "5", magie: -1 }, items: ["√âp√©e", "Hache", "Masse", "Lance (1 main)", "Fl√©au"] },
            "Courte": { label: "Armes Courtes", stats: { init: "6", magie: -1 }, items: ["Dague", "√âp√©e courte", "Torche", "Main Libre"] }
        };

        const RULES = {
            ARMORS: {
                "Aucune": { dur: 0, res: 0, malus: [] },
                "L√©g√®re": { dur: 6, res: 1, malus: ["acrobatie", "athletisme", "magie"] },
                "L√©g√®re_Heaume": { dur: 6, res: 1, malus: ["acrobatie", "athletisme", "magie", "perception", "acrobatie"] }, 
                "Moyenne": { dur: 8, res: 2, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "magie"] },
                "Moyenne_Heaume": { dur: 8, res: 2, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "magie", "perception", "acrobatie"] },
                "Lourde": { dur: 10, res: 3, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "perception", "magie"] },
                "Lourde_Heaume": { dur: 10, res: 3, malus: ["acrobatie", "athletisme", "mecanique", "subtilite", "perception", "magie", "perception", "acrobatie"] } 
            },
            RACES: { "ELFE": ["acrobatie", "perception", "survie"], "NAIN": ["athletisme", "mecanique", "savoir_acad"], "ORQUE": ["athletisme", "survie"], "HUMAIN": [] }
        };

        const talentsList = [ { id: 'athletisme', label: 'Athl√©tisme' }, { id: 'acrobatie', label: 'Acrobatie' }, { id: 'mecanique', label: 'M√©canique' }, { id: 'subtilite', label: 'Subtilit√©' }, { id: 'perception', label: 'Perception' }, { id: 'survie', label: 'Survie' }, { id: 'savoir_acad', label: 'Savoir Acad.' } ];

        function initWeaponSelect() {
            [1, 2].forEach(index => {
                const select = document.getElementById(`weapon-select-${index}`);
                if (!select) return;
                select.innerHTML = '';
                for (const [key, category] of Object.entries(WEAPONS_DATA)) {
                    const group = document.createElement('optgroup'); group.label = category.label;
                    category.items.forEach(item => { const option = document.createElement('option'); option.value = item; option.textContent = item; group.appendChild(option); });
                    select.appendChild(group);
                }
                select.value = "Main Libre";
            });
            updateUI();
        }

        function getWeaponStats(name) {
            if (["Grimoire", "Chapelet", "B√¢ton"].includes(name)) return { init: "6", magie: 0 };
            for (const cat of Object.values(WEAPONS_DATA)) if (cat.items.includes(name)) return cat.stats;
            return { init: "-", magie: 0 };
        }
        function getWeaponCategory(name) {
            for (const [key, cat] of Object.entries(WEAPONS_DATA)) if (cat.items.includes(name)) return key;
            return "Courte";
        }

        function updateOffhandOptions(index) {
            const wSel = document.getElementById(`weapon-select-${index}`);
            const oSel = document.getElementById(`offhand-select-${index}`);
            if (!wSel || !oSel) return;
            const wName = wSel.value;
            const cat = getWeaponCategory(wName);
            const cur = oSel.value;
            oSel.innerHTML = ''; oSel.disabled = false;
            let opts = [];
            if (cat === "Distance" || cat === "Longue") { opts.push("Occup√©e"); oSel.disabled = true; }
            else if (cat === "Focalisateur") { if (wName === "B√¢ton") opts.push("Occup√©e ou Libre", "Bouclier", "Torche"); else opts.push("Main Libre (Incantation)", "Bouclier", "Torche"); }
            else if (cat === "Moyenne") opts.push("Main Libre", "Bouclier", "Torche");
            else { opts.push("Main Libre", "Bouclier", "Torche"); WEAPONS_DATA["Courte"].items.forEach(wp => { if (!["Main Libre", "Torche", "Bouclier (Offensif)"].includes(wp)) opts.push(wp); }); }
            opts.forEach(opt => { const el = document.createElement('option'); el.value = opt; el.textContent = opt; oSel.appendChild(el); });
            if (Array.from(oSel.options).some(o => o.value === cur)) oSel.value = cur; else oSel.selectedIndex = 0;
        }

        function updatePortrait() {
            const r = document.getElementById('race-select')?.value; const g = document.getElementById('gender-select')?.value; const c = document.getElementById('portrait-container');
            if(!r || !g || !c) return;
            const k = `${r}_${g}`;
            c.innerHTML = CUSTOM_PORTRAITS_URLS[k] ? `<img src="${CUSTOM_PORTRAITS_URLS[k]}" class="portrait-img-custom">` : `<div style="font-size:10px; font-weight:bold;">PORTRAIT</div>`;
        }

        function updateRace() {
            const r = document.getElementById('race-select')?.value; if(!r) return;
            Object.keys(state.talents).forEach(k => state.talents[k] = false);
            if(RULES.RACES[r]) RULES.RACES[r].forEach(t => state.talents[t] = true);
            const s = document.getElementById('stat-att-saisie'); if(s) s.value = (r === "ORQUE") ? 1 : 0;
            triggerSave(); updateUI();
        }
        function toggleTalent(id) { state.talents[id] = !state.talents[id]; triggerSave(); updateUI(); }

        function updateUI() {
            [1, 2].forEach(i => {
                const wSel = document.getElementById(`weapon-select-${i}`); const oSel = document.getElementById(`offhand-select-${i}`);
                if (wSel && oSel) {
                    if (document.activeElement === wSel) updateOffhandOptions(i);
                    const wName = wSel.value; const oName = oSel.value; const stats = getWeaponStats(wName); const cat = getWeaponCategory(wName);
                    const free = wName==="Main Libre" || (oName && (oName.includes("Libre") || oName.includes("Occup√©e")));
                    const cata = (wName!=="Main Libre" && wName!=="Torche") || (oName && !["Main Libre","Main Libre (Incantation)","Bouclier","Torche","Occup√©e","Occup√©e ou Libre"].includes(oName));
                    const canCast = free && cata;
                    const iSpan = document.getElementById(`init-val-${i}`);
                    if(iSpan) {
                        iSpan.className="font-digit font-bold text-sm text-black";
                        if(canCast) iSpan.innerHTML = wName==="B√¢ton" ? `5<span class="text-[8px]">(1m)</span> 4<span class="text-[8px]">(2m)</span> / SORT 2<span class="text-[8px]">(lib)</span>` : `${stats.init} / SORT 2<span class="text-[8px]">(lib)</span>`;
                        else iSpan.innerHTML = wName==="B√¢ton" ? `5<span class="text-[8px]">(1m)</span> 4<span class="text-[8px]">(2m)</span>` : stats.init;
                    }
                    const mSpan = document.getElementById(`magic-malus-${i}`);
                    if(mSpan) {
                        if(!free || !cata) { mSpan.innerText = "imp."; mSpan.style.color="#dc2626"; }
                        else { mSpan.innerText = cat==="Focalisateur" ? 0 : stats.magie; mSpan.style.color="black"; }
                    }
                }
            });
            const aSel = document.getElementById('armor-select');
            if(aSel) {
                const arm = aSel.value; const dat = RULES.ARMORS[arm];
                const base = dat ? dat.res : 0; const head = arm.includes("_Heaume") ? base : 0;
                document.getElementById('res-arm-tete').innerText = head; document.getElementById('res-arm-tronc').innerText = base; document.getElementById('res-arm-membres').innerText = base;
                let mal = 0; if(dat && dat.malus && dat.malus.includes("magie")) mal = -1;
                document.getElementById('magic-malus-armor').innerText = (mal >= 0 ? "+" : "") + mal;
                document.getElementById('dur-display').innerText = `${dat ? dat.dur : 0}/${dat ? dat.dur : 0}`;
                
                const tCont = document.getElementById('talents-container');
                if(tCont) {
                    let html = `<table style="width:100%; border-collapse:collapse;">`;
                    talentsList.forEach(t => {
                        const chk = state.talents[t.id]; const baseS = chk ? 1 : 0;
                        let aMal = 0; if(dat && dat.malus) aMal = -dat.malus.filter(m => m === t.id).length;
                        html += `<tr style="cursor:pointer;" onclick="toggleTalent('${t.id}')">
                            <td style="border-bottom:1px solid #ccc;"><div class="check-box ${chk?'active':''}"></div><span style="font-size:0.7rem; font-weight:bold; text-transform:uppercase;">${t.label}</span></td>
                            <td style="text-align:center; font-family:'Spectral'; font-weight:bold; width:20px;">${baseS}</td>
                            <td style="text-align:center; font-family:'Spectral'; font-weight:bold; width:20px; color:${aMal<0?'red':'black'}">${aMal}</td>
                            <td style="text-align:center; font-family:'Spectral'; font-weight:bold; width:25px;">= ${baseS+aMal}</td>
                        </tr>`;
                    });
                    html += `</table>`;
                    tCont.innerHTML = html;
                }
            }
        }
    </script>
</body>
</html>
